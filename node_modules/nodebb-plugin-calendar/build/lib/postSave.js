'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.postEditCallback = exports.postSaveCallback = exports.postSave = undefined;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }();

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _validator = require('validator');

var _validator2 = _interopRequireDefault(_validator);

var _parse = require('./parse');

var _parse2 = _interopRequireDefault(_parse);

var _privileges = require('./privileges');

var _event = require('./event');

var _validateEvent3 = require('./validateEvent');

var _validateEvent4 = _interopRequireDefault(_validateEvent3);

var _reminders = require('./reminders');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const plugins = require.main.require('./src/plugins');
// const winston = require.main.require('winston');

const log = (...args) => console.log(...args);
const p = _bluebird2.default.promisify;

const fireHook = p(plugins.fireHook);

const regex = new RegExp('(\\[\\s?event\\s?\\][\\w\\W]*\\[\\s?\\/\\s?event\\s?\\])|' + '(\\[\\s?event\\-invalid?\\s?\\][\\w\\W]*\\[\\s?\\/\\s?event\\-invalid?\\s?\\])');

const postSave = (() => {
  var ref = (0, _bluebird.coroutine)(function* (postData) {
    let event = (0, _parse2.default)(postData.content);

    // delete event if no longer in post
    if (!postData.content.match(regex)) {
      const existed = yield (0, _event.eventExists)(postData.pid);
      if (existed) {
        yield (0, _reminders.notify)({
          event: yield (0, _event.getEvent)(postData.pid),
          message: '[[calendar:event_deleted]]'
        });

        yield (0, _event.deleteEvent)(postData.pid);
        log(`[plugin-calendar] Event (pid:${ postData.pid }) deleted`);
      }

      return postData;
    }

    const invalid = function invalid() {
      return _extends({}, postData, {
        content: postData.content.replace(/\[\s?(\/?)\s?event\s?\]/g, '[$1event-invalid]')
      });
    };

    if (!event) {
      return invalid();
    }

    var _validateEvent = (0, _validateEvent4.default)(event);

    var _validateEvent2 = _slicedToArray(_validateEvent, 2);

    const failed = _validateEvent2[0];
    const failures = _validateEvent2[1];

    if (failed) {
      const obj = failures.reduce(function (val, failure) {
        return _extends({}, val, {
          [failure]: event[failure]
        });
      }, {});
      log(`[plugin-calendar] Event (pid:${ postData.pid }) validation failed: `, obj);
      return invalid();
    }

    const can = yield (0, _privileges.canPostEvent)(postData.pid, postData.uid);
    if (!can) {
      return invalid();
    }

    event.name = _validator2.default.escape(event.name);
    event.pid = postData.pid;
    event.tid = postData.tid;
    event.uid = postData.uid;
    event = yield fireHook('filter:plugin-calendar:event.post', event);

    yield (0, _event.saveEvent)(event);
    log(`[plugin-calendar] Event (pid:${ event.pid }) saved`);

    return postData;
  });
  return function postSave(_x) {
    return ref.apply(this, arguments);
  };
})();

const postSaveCallback = (postData, cb) => postSave(postData).asCallback(cb);
const postEditCallback = (data, cb) => postSave(data.post).then(postData => _extends({}, data, {
  post: postData
})).asCallback(cb);

exports.postSave = postSave;
exports.postSaveCallback = postSaveCallback;
exports.postEditCallback = postEditCallback;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcG9zdFNhdmUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBR0E7Ozs7QUFFQTs7OztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7QUFUQSxNQUFNLFVBQVUsUUFBUSxJQUFSLENBQWEsT0FBYixDQUFxQixlQUFyQixDQUFoQjs7O0FBV0EsTUFBTSxNQUFNLENBQUMsR0FBRyxJQUFKLEtBQWEsUUFBUSxHQUFSLENBQVksR0FBRyxJQUFmLENBQXpCO0FBQ0EsTUFBTSxJQUFJLG1CQUFRLFNBQWxCOztBQUVBLE1BQU0sV0FBVyxFQUFFLFFBQVEsUUFBVixDQUFqQjs7QUFFQSxNQUFNLFFBQVEsSUFBSSxNQUFKLENBQ1osOERBQ0EsZ0ZBRlksQ0FBZDs7QUFLQSxNQUFNO0FBQUEscUNBQVcsV0FBTSxRQUFOLEVBQWtCO0FBQ2pDLFFBQUksUUFBUSxxQkFBTSxTQUFTLE9BQWYsQ0FBWjs7O0FBR0EsUUFBSSxDQUFDLFNBQVMsT0FBVCxDQUFpQixLQUFqQixDQUF1QixLQUF2QixDQUFMLEVBQW9DO0FBQ2xDLFlBQU0sVUFBVSxNQUFNLHdCQUFZLFNBQVMsR0FBckIsQ0FBdEI7QUFDQSxVQUFJLE9BQUosRUFBYTtBQUNYLGNBQU0sdUJBQU87QUFDWCxpQkFBTyxNQUFNLHFCQUFTLFNBQVMsR0FBbEIsQ0FERjtBQUVYLG1CQUFTO0FBRkUsU0FBUCxDQUFOOztBQUtBLGNBQU0sd0JBQVksU0FBUyxHQUFyQixDQUFOO0FBQ0EsWUFBSyxpQ0FBK0IsU0FBUyxHQUFJLFlBQWpEO0FBQ0Q7O0FBRUQsYUFBTyxRQUFQO0FBQ0Q7O0FBRUQsVUFBTSxVQUFVLFNBQVYsT0FBVTtBQUFBLDBCQUNYLFFBRFc7QUFFZCxpQkFBUyxTQUFTLE9BQVQsQ0FBaUIsT0FBakIsQ0FDUCwwQkFETyxFQUVQLG1CQUZPO0FBRks7QUFBQSxLQUFoQjs7QUFRQSxRQUFJLENBQUMsS0FBTCxFQUFZO0FBQ1YsYUFBTyxTQUFQO0FBQ0Q7O0FBN0JnQyx5QkErQk4sNkJBQWMsS0FBZCxDQS9CTTs7QUFBQTs7QUFBQSxVQStCMUIsTUEvQjBCO0FBQUEsVUErQmxCLFFBL0JrQjs7QUFnQ2pDLFFBQUksTUFBSixFQUFZO0FBQ1YsWUFBTSxNQUFNLFNBQVMsTUFBVCxDQUFnQixVQUFDLEdBQUQsRUFBTSxPQUFOO0FBQUEsNEJBQ3ZCLEdBRHVCO0FBRTFCLFdBQUMsT0FBRCxHQUFXLE1BQU0sT0FBTjtBQUZlO0FBQUEsT0FBaEIsRUFHUixFQUhRLENBQVo7QUFJQSxVQUFLLGlDQUErQixTQUFTLEdBQUksd0JBQWpELEVBQXlFLEdBQXpFO0FBQ0EsYUFBTyxTQUFQO0FBQ0Q7O0FBRUQsVUFBTSxNQUFNLE1BQU0sOEJBQWEsU0FBUyxHQUF0QixFQUEyQixTQUFTLEdBQXBDLENBQWxCO0FBQ0EsUUFBSSxDQUFDLEdBQUwsRUFBVTtBQUNSLGFBQU8sU0FBUDtBQUNEOztBQUVELFVBQU0sSUFBTixHQUFhLG9CQUFVLE1BQVYsQ0FBaUIsTUFBTSxJQUF2QixDQUFiO0FBQ0EsVUFBTSxHQUFOLEdBQVksU0FBUyxHQUFyQjtBQUNBLFVBQU0sR0FBTixHQUFZLFNBQVMsR0FBckI7QUFDQSxVQUFNLEdBQU4sR0FBWSxTQUFTLEdBQXJCO0FBQ0EsWUFBUSxNQUFNLFNBQVMsbUNBQVQsRUFBOEMsS0FBOUMsQ0FBZDs7QUFFQSxVQUFNLHNCQUFVLEtBQVYsQ0FBTjtBQUNBLFFBQUssaUNBQStCLE1BQU0sR0FBSSxVQUE5Qzs7QUFFQSxXQUFPLFFBQVA7QUFDRCxHQXhESztBQUFBO0FBQUE7QUFBQTtBQUFBLElBQU47O0FBMERBLE1BQU0sbUJBQW1CLENBQUMsUUFBRCxFQUFXLEVBQVgsS0FBa0IsU0FBUyxRQUFULEVBQW1CLFVBQW5CLENBQThCLEVBQTlCLENBQTNDO0FBQ0EsTUFBTSxtQkFBbUIsQ0FBQyxJQUFELEVBQU8sRUFBUCxLQUN2QixTQUFTLEtBQUssSUFBZCxFQUFvQixJQUFwQixDQUF5Qix5QkFDcEIsSUFEb0I7QUFFdkIsUUFBTTtBQUZpQixFQUF6QixFQUdJLFVBSEosQ0FHZSxFQUhmLENBREY7O1FBTVMsUSxHQUFBLFE7UUFBVSxnQixHQUFBLGdCO1FBQWtCLGdCLEdBQUEsZ0IiLCJmaWxlIjoicG9zdFNhdmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwbHVnaW5zID0gcmVxdWlyZS5tYWluLnJlcXVpcmUoJy4vc3JjL3BsdWdpbnMnKTtcclxuLy8gY29uc3Qgd2luc3RvbiA9IHJlcXVpcmUubWFpbi5yZXF1aXJlKCd3aW5zdG9uJyk7XHJcblxyXG5pbXBvcnQgdmFsaWRhdG9yIGZyb20gJ3ZhbGlkYXRvcic7XHJcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcclxuaW1wb3J0IHBhcnNlIGZyb20gJy4vcGFyc2UnO1xyXG5pbXBvcnQgeyBjYW5Qb3N0RXZlbnQgfSBmcm9tICcuL3ByaXZpbGVnZXMnO1xyXG5pbXBvcnQgeyBkZWxldGVFdmVudCwgc2F2ZUV2ZW50LCBldmVudEV4aXN0cywgZ2V0RXZlbnQgfSBmcm9tICcuL2V2ZW50JztcclxuaW1wb3J0IHZhbGlkYXRlRXZlbnQgZnJvbSAnLi92YWxpZGF0ZUV2ZW50JztcclxuaW1wb3J0IHsgbm90aWZ5IH0gZnJvbSAnLi9yZW1pbmRlcnMnO1xyXG5cclxuY29uc3QgbG9nID0gKC4uLmFyZ3MpID0+IGNvbnNvbGUubG9nKC4uLmFyZ3MpO1xyXG5jb25zdCBwID0gUHJvbWlzZS5wcm9taXNpZnk7XHJcblxyXG5jb25zdCBmaXJlSG9vayA9IHAocGx1Z2lucy5maXJlSG9vayk7XHJcblxyXG5jb25zdCByZWdleCA9IG5ldyBSZWdFeHAoXHJcbiAgJyhcXFxcW1xcXFxzP2V2ZW50XFxcXHM/XFxcXF1bXFxcXHdcXFxcV10qXFxcXFtcXFxccz9cXFxcL1xcXFxzP2V2ZW50XFxcXHM/XFxcXF0pfCcgK1xyXG4gICcoXFxcXFtcXFxccz9ldmVudFxcXFwtaW52YWxpZD9cXFxccz9cXFxcXVtcXFxcd1xcXFxXXSpcXFxcW1xcXFxzP1xcXFwvXFxcXHM/ZXZlbnRcXFxcLWludmFsaWQ/XFxcXHM/XFxcXF0pJ1xyXG4pO1xyXG5cclxuY29uc3QgcG9zdFNhdmUgPSBhc3luYyBwb3N0RGF0YSA9PiB7XHJcbiAgbGV0IGV2ZW50ID0gcGFyc2UocG9zdERhdGEuY29udGVudCk7XHJcblxyXG4gIC8vIGRlbGV0ZSBldmVudCBpZiBubyBsb25nZXIgaW4gcG9zdFxyXG4gIGlmICghcG9zdERhdGEuY29udGVudC5tYXRjaChyZWdleCkpIHtcclxuICAgIGNvbnN0IGV4aXN0ZWQgPSBhd2FpdCBldmVudEV4aXN0cyhwb3N0RGF0YS5waWQpO1xyXG4gICAgaWYgKGV4aXN0ZWQpIHtcclxuICAgICAgYXdhaXQgbm90aWZ5KHtcclxuICAgICAgICBldmVudDogYXdhaXQgZ2V0RXZlbnQocG9zdERhdGEucGlkKSxcclxuICAgICAgICBtZXNzYWdlOiAnW1tjYWxlbmRhcjpldmVudF9kZWxldGVkXV0nLFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGF3YWl0IGRlbGV0ZUV2ZW50KHBvc3REYXRhLnBpZCk7XHJcbiAgICAgIGxvZyhgW3BsdWdpbi1jYWxlbmRhcl0gRXZlbnQgKHBpZDoke3Bvc3REYXRhLnBpZH0pIGRlbGV0ZWRgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcG9zdERhdGE7XHJcbiAgfVxyXG5cclxuICBjb25zdCBpbnZhbGlkID0gKCkgPT4gKHtcclxuICAgIC4uLnBvc3REYXRhLFxyXG4gICAgY29udGVudDogcG9zdERhdGEuY29udGVudC5yZXBsYWNlKFxyXG4gICAgICAvXFxbXFxzPyhcXC8/KVxccz9ldmVudFxccz9cXF0vZyxcclxuICAgICAgJ1skMWV2ZW50LWludmFsaWRdJ1xyXG4gICAgKSxcclxuICB9KTtcclxuXHJcbiAgaWYgKCFldmVudCkge1xyXG4gICAgcmV0dXJuIGludmFsaWQoKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IFtmYWlsZWQsIGZhaWx1cmVzXSA9IHZhbGlkYXRlRXZlbnQoZXZlbnQpO1xyXG4gIGlmIChmYWlsZWQpIHtcclxuICAgIGNvbnN0IG9iaiA9IGZhaWx1cmVzLnJlZHVjZSgodmFsLCBmYWlsdXJlKSA9PiAoe1xyXG4gICAgICAuLi52YWwsXHJcbiAgICAgIFtmYWlsdXJlXTogZXZlbnRbZmFpbHVyZV0sXHJcbiAgICB9KSwge30pO1xyXG4gICAgbG9nKGBbcGx1Z2luLWNhbGVuZGFyXSBFdmVudCAocGlkOiR7cG9zdERhdGEucGlkfSkgdmFsaWRhdGlvbiBmYWlsZWQ6IGAsIG9iaik7XHJcbiAgICByZXR1cm4gaW52YWxpZCgpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgY2FuID0gYXdhaXQgY2FuUG9zdEV2ZW50KHBvc3REYXRhLnBpZCwgcG9zdERhdGEudWlkKTtcclxuICBpZiAoIWNhbikge1xyXG4gICAgcmV0dXJuIGludmFsaWQoKTtcclxuICB9XHJcblxyXG4gIGV2ZW50Lm5hbWUgPSB2YWxpZGF0b3IuZXNjYXBlKGV2ZW50Lm5hbWUpO1xyXG4gIGV2ZW50LnBpZCA9IHBvc3REYXRhLnBpZDtcclxuICBldmVudC50aWQgPSBwb3N0RGF0YS50aWQ7XHJcbiAgZXZlbnQudWlkID0gcG9zdERhdGEudWlkO1xyXG4gIGV2ZW50ID0gYXdhaXQgZmlyZUhvb2soJ2ZpbHRlcjpwbHVnaW4tY2FsZW5kYXI6ZXZlbnQucG9zdCcsIGV2ZW50KTtcclxuXHJcbiAgYXdhaXQgc2F2ZUV2ZW50KGV2ZW50KTtcclxuICBsb2coYFtwbHVnaW4tY2FsZW5kYXJdIEV2ZW50IChwaWQ6JHtldmVudC5waWR9KSBzYXZlZGApO1xyXG5cclxuICByZXR1cm4gcG9zdERhdGE7XHJcbn07XHJcblxyXG5jb25zdCBwb3N0U2F2ZUNhbGxiYWNrID0gKHBvc3REYXRhLCBjYikgPT4gcG9zdFNhdmUocG9zdERhdGEpLmFzQ2FsbGJhY2soY2IpO1xyXG5jb25zdCBwb3N0RWRpdENhbGxiYWNrID0gKGRhdGEsIGNiKSA9PlxyXG4gIHBvc3RTYXZlKGRhdGEucG9zdCkudGhlbihwb3N0RGF0YSA9PiAoe1xyXG4gICAgLi4uZGF0YSxcclxuICAgIHBvc3Q6IHBvc3REYXRhLFxyXG4gIH0pKS5hc0NhbGxiYWNrKGNiKTtcclxuXHJcbmV4cG9ydCB7IHBvc3RTYXZlLCBwb3N0U2F2ZUNhbGxiYWNrLCBwb3N0RWRpdENhbGxiYWNrIH07XHJcbiJdfQ==