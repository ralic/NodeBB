'use strict';

/* global define, $, app, config, socket */

define('admin/plugins/newsletter', ['translator', 'uploader', '/vendor/ace/ext-language_tools.js'], function (translator, uploader) {
  var Newsletter = {};

  Newsletter.init = function () {
    var editor = ace.edit('newsletter-template');
    var snippetManager = ace.require("ace/snippets").snippetManager;

    editor.setTheme('ace/theme/twilight');
    editor.getSession().setMode('ace/mode/html');

    $('#newsletter-preview').click(function () {
      $('#newsletter-modal-subject').html($('#newsletter-subject').val());
      $('#newsletter-modal-body').html(editor.getValue());
    });

    var $newsletter = $('#newsletter');

    $('#newsletter-send').click(function () {
      // Append origin to uploaded images/files.
      var body = editor.getValue();
      var port = window.location.port ? ':' + window.location.port : '';
      var origin = window.location.protocol + '//' + window.location.hostname + port;

      body = body.replace(new RegExp('(href="' + config.relative_path + ')(/)', 'gi'), '$1' + origin + '$2');
      body = body.replace(new RegExp('(src="' + config.relative_path + ')(/)', 'gi'), '$1' + origin + '$2');

      socket.emit('admin.Newsletter.send', {
        subject: $('#newsletter-subject').val(),
        template: body,
        group: $('#newsletter-group').val()
      }, function (success) {
        if (success) {
          app.alert({
            type: 'success',
            alert_id: 'newsletter-send',
            title: 'Newsletter Sent',
            timeout: 5000
          });
        } else {
          app.alert({
            type: 'error',
            alert_id: 'newsletter-send',
            title: 'Error',
            timeout: 5000
          });
        }
      });
    });

    function snipIt(snippet) {
      return function () {
        snippetManager.insertSnippet(editor, snippet);
        editor.focus();
      };
    }

    $('#bold').click(snipIt('<b>${0:$SELECTION}</b>'));
    $('#italic').click(snipIt('<i>${0:$SELECTION}</i>'));
    $('#strikethrough').click(snipIt('<s>${0:$SELECTION}</s>'));
    $('#link').click(snipIt('<a href="${0:url}">$SELECTION</a>'));
    $('#image').click(snipIt('<img src="${0:url}">'));

    $('#upload').click(function () {
      uploader.show({ route: '/api/post/upload' }, function (path) {
        if (path.match(/png|jpeg|jpg|gif|bmp/)) {
          snipIt('<img src="' + path + '">${0}')();
        } else {
          snipIt('<a href="' + path + '">${0:uploaded file}</a>')();
        }
        setTimeout(function () {
          editor.focus();
        }, 1200);
      });
    });
  };

  return Newsletter;
});