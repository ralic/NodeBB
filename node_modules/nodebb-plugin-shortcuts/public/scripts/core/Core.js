define("plugin/shortcuts/Core",["plugin/shortcuts/debug","plugin/shortcuts","plugin/shortcuts/input-fields","plugin/shortcuts/KeyAction","plugin/shortcuts/key-codes"],function(a,b,c,d,e){"use strict";/*=================================================== Core Class ===================================================*/
/*-------------------------------------------------- constructor  --------------------------------------------------*/
function f(a){this.bindings=[],this.actions={},this.repeatDelay=a.repeatDelay||200,this.lastTriggered={keyAction:null,time:0};var b=app.inAdmin||app.user.isAdmin?$.extend(!0,{},a.actions,a.adminActions):a.actions;this.parseBindings(b)}function g(a){return"-"+a.toLowerCase()}/*===================================================== Export =====================================================*/
/*-------------------------------------------- bindings initialization  --------------------------------------------*/
/*----------------------------------------------- action management  -----------------------------------------------*/
//noinspection JSUnusedGlobalSymbols
/*------------------------------------------------- event handling -------------------------------------------------*/
/*-------------------------------------------------- help dialog  --------------------------------------------------*/
return f.prototype.attachTheme=function(a){this.theme=a},f.prototype.addKeyAction=function(b){a.log(" ","addKeyAction",b),this.bindings.push(b),this.actions.hasOwnProperty(b.action)&&this.actions[b.action].bindings.push(b)},f.prototype.parseBindings=function(a,b){b||(b="");var c,e,f,g;
// clean up current bindings
for(c=0;c<this.actions.length;c++)this.actions[c].bindings=[];for(g in a)if(a.hasOwnProperty(g))
// process value
if(e=a[g],f=b.length?b+"."+g:g,e instanceof Array)for(c=0;c<e.length;c++)this.addKeyAction(new d(e[c],f));else"object"==typeof e?this.parseBindings(e,f):this.addKeyAction(new d(e,f))},f.prototype.startWatching=function(a){var b=this;
// watch for keyboard events and forward them (normalized) to core instance
a.keydown(function(a){var c;a=a||window.event,c=a.which=a.which||a.keyCode||a.key,b.handleEvent(a,c)}),a.keyup(function(){b.released()}),
// watch for "?" key pressed to show help modal
a.keypress(function(a){var d;a=a||window.event,~c.indexOf($(a.target).prop("tagName"))||(d=a.which||a.keyCode||a.key,d===e.questionMark&&b.help())})},f.prototype.wrapAction=function(a,b){this.actions.hasOwnProperty(a)?this.actions[a].cb=b(this.actions[a].cb):this.setAction(a,b($.noop))},f.prototype.setAction=function(a,b){for(var c=[],d=0;d<this.bindings.length;d++)this.bindings[d].action===a&&c.push(this.bindings[d]);this.actions[a]={cb:b,bindings:c}},f.prototype.mergeActions=function(a,b){null==b&&(b="");var c,d;for(var e in a)a.hasOwnProperty(e)&&(c=a[e],d=b.length?b+"."+e:e,"object"==typeof c?this.mergeActions(c,d):"function"==typeof c&&this.setAction(d,c))},f.prototype.prependToAction=function(a,b){this.wrapAction(a,function(a){return function(){var c=b.apply(null,arguments);return c===!1?!1:a.apply(null,arguments)}})},f.prototype.appendToAction=function(a,b,c){this.wrapAction(a,function(a){return function(){var d=a.apply(null,arguments);return d!==!1||c?b.apply(null,arguments):!1}})},f.prototype.released=function(){this.lastTriggered.time=0},f.prototype.handleEvent=function(b,d){if(a.enabled&&// don't calculate logging string if disabled enyways
a._log("Key Down: "+(b.ctrlKey?"C-":"")+(b.altKey?"A-":"")+(b.shiftKey?"S-":"")+(b.metaKey?"M-":"")+d),null!=this.theme){var e,f,g=!!~c.indexOf(b.target.tagName),h=[],i=this.theme.scopes.getCurrent();a.log(" ","Scopes matching event-target",i);
// collect all matching keyActions
var j;for(e=0;e<this.bindings.length;e++)if(j=this.bindings[e],j.matches(b,d,g))for(f=0;f<i.length;f++)if(0===j.action.search(i[f]+".")){h.push({keyAction:j,priority:f});break}if(h.length){
// log actions to be triggered if debugging is enabled
if(
// sort matching keyActions by priority (by scope they apply to)
h.sort(function(a,b){return a.priority-b.priority}),a.enabled){var k=$.map(h,function(a){return a.keyAction.action});a._log(" ","["+k.join(", ")+"] match the event.")}var l=$.now();
// trigger actions
for(e=0;e<h.length&&(j=h[e].keyAction,!(j===this.lastTriggered.keyAction&&l-this.lastTriggered.time<=this.repeatDelay));e++)if(this.trigger(j.action,b)!==!1)return this.lastTriggered.keyAction=j,this.lastTriggered.time=l,void a.log(" ",j.action,"stops further handling")}}},f.prototype.trigger=function(b,c){if(this.actions.hasOwnProperty(b)){var d,e=this.actions[b];if(null!=e&&"function"==typeof e.cb)
// action has callback, so call it
return d=e.cb.call(c&&c.target,this,c),d!==!1&&null!=c&&(c.preventDefault(),c.stopPropagation()),a.log(" ",b,"got triggered and returned",d),d}return!1},f.prototype.help=function(){var a="shortcuts-help-body",c=this.theme,d=this;if(this.helpInProgress)return!1;if($("#"+a).length)return void(null!=c&&c.dialogs.getOpened().each(function(a,b){c.dialogs.close(b)}));this.helpInProgress=!0;var e=$("<div>NodeBB Shortcuts <small>"+b.version+"</small> / [[shortcuts:settings.actions]]"+(app.inAdmin?" <small>[[shortcuts:settings.acp]]</small>":"")+"</div>"),f=this.getHelpBlock(a);return require(["translator"],function(a){a.translate(f.html(),function(a){f.html(a);
// open dialog
var b=bootbox.dialog({title:e,message:f,className:"shortcuts-help"});b.find(">.modal-dialog").addClass("modal-lg"),b.on("shown.bs.modal",function(){d.helpInProgress=!1,b.focus()})})}),!0},f.prototype.expandSubActions=function(a){for(var b,c,d=[],e=0;e<a.length;e++){b=a[e],c=b+".";for(var f in this.actions)this.actions.hasOwnProperty(f)&&(f===b||f.startsWith(c))&&d.push(f)}return d},f.prototype.getHelpBlock=function(a){var b,c,d,e,f,h,i,j=$('<div id="'+a+'"></div>'),k=$(),l=$(),m=null;for(app.inAdmin?(h=this.expandSubActions(["acp","body","dialog"]),i=[]):(h=Object.keys(this.actions),i=this.expandSubActions(["acp"])),d=0;d<h.length;d++){var n=h[d];if(this.actions.hasOwnProperty(n)&&!~i.indexOf(n)){if(b=this.actions[n].bindings,!b.length)continue;for(f=n.replace(/[A-Z]/g,g),c=n.split(".")[0],m!==c&&(k=$('<div class="key-bindings-group row" id="key-bindings-'+f.split(".")[0]+'"></div>').append('<div class="col-xs-12 key-bindings-group-header">[[shortcuts:actions.'+c+"]]</div>").appendTo(j),m=c),l=$('<div class="key-action col-xs-6 col-md-4" id="key-action-'+f+'"></div>').append('<div class="key-action-header">[[shortcuts:actions.'+n+"]]</div>").appendTo(k),e=0;e<b.length;e++)l.append('<code class="key-binding">'+b[e].keyString+"</code>")}}return j},f});